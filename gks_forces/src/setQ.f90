subroutine setQ(Q,i,j,A)
include "setup.inc"
integer i,j
real*8 A(3,3)
real*8 Q(0:3,NP,0:DEG)
real*8 dQ(0:3),AH(3,3)
integer k,ns,it,k1,k2
real*8  norm,ds,zz
Q(3,i,j)=sqrt(1.0d0+A(1,1)+A(2,2)+A(3,3))/2.0d0
Q(0,i,j)=(A(2,3)-A(3,2))/(4.0d0*Q(3,i,j))
Q(1,i,j)=(A(3,1)-A(1,3))/(4.0d0*Q(3,i,j))
Q(2,i,j)=(A(1,2)-A(2,1))/(4.0d0*Q(3,i,j))
norm=dot_product(Q(:,i,j),Q(:,i,j))
norm=sqrt(norm)
Q(:,i,j)=Q(:,i,j)/norm
ds=0.01d0
ns=1000
do it=1,ns
  AH(1,1)=Q(3,i,j)**2+Q(0,i,j)**2-Q(1,i,j)**2-Q(2,i,j)**2
  AH(1,2)=2.0d0*(Q(0,i,j)*Q(1,i,j)+Q(3,i,j)*Q(2,i,j))
  AH(1,3)=2.0d0*(Q(0,i,j)*Q(2,i,j)-Q(3,i,j)*Q(1,i,j))
  AH(2,1)=2.0d0*(Q(0,i,j)*Q(1,i,j)-Q(3,i,j)*Q(2,i,j))
  AH(2,2)=Q(3,i,j)**2-Q(0,i,j)**2+Q(1,i,j)**2-Q(2,i,j)**2
  AH(2,3)=2.0d0*(Q(1,i,j)*Q(2,i,j)+Q(3,i,j)*Q(0,i,j))
  AH(3,1)=2.0d0*(Q(0,i,j)*Q(2,i,j)+Q(3,i,j)*Q(1,i,j))
  AH(3,2)=2.0d0*(Q(1,i,j)*Q(2,i,j)-Q(3,i,j)*Q(0,i,j))
  AH(3,3)=Q(3,i,j)**2-Q(0,i,j)**2-Q(1,i,j)**2+Q(2,i,j)**2
  zz=Q(3,i,j)**2+Q(0,i,j)**2+Q(1,i,j)**2+Q(2,i,j)**2-1.0d0
  norm=zz**2
  do k1=1,3
    do k2=1,3
      norm=norm+(AH(k1,k2)-A(k1,k2))**2
    enddo
  enddo
  dQ(3)=      2.0d0*(AH(1,1)-A(1,1))*2.0*Q(3,i,j)
  dQ(3)=dQ(3)+2.0d0*(AH(1,2)-A(1,2))*2.0*Q(2,i,j)
  dQ(3)=dQ(3)-2.0d0*(AH(1,3)-A(1,3))*2.0*Q(1,i,j)
  dQ(3)=dQ(3)-2.0d0*(AH(2,1)-A(2,1))*2.0*Q(2,i,j)
  dQ(3)=dQ(3)+2.0d0*(AH(2,2)-A(2,2))*2.0*Q(3,i,j)
  dQ(3)=dQ(3)+2.0d0*(AH(2,3)-A(2,3))*2.0*Q(0,i,j)
  dQ(3)=dQ(3)+2.0d0*(AH(3,1)-A(3,1))*2.0*Q(1,i,j)
  dQ(3)=dQ(3)-2.0d0*(AH(3,2)-A(3,2))*2.0*Q(0,i,j)
  dQ(3)=dQ(3)+2.0d0*(AH(3,3)-A(3,3))*2.0*Q(3,i,j)
  dQ(3)=dQ(3)+2.0d0*zz*2.0*Q(3,i,j)
  dQ(0)=      2.0d0*(AH(1,1)-A(1,1))*2.0*Q(0,i,j)
  dQ(0)=dQ(0)+2.0d0*(AH(1,2)-A(1,2))*2.0*Q(1,i,j)
  dQ(0)=dQ(0)+2.0d0*(AH(1,3)-A(1,3))*2.0*Q(2,i,j)
  dQ(0)=dQ(0)+2.0d0*(AH(2,1)-A(2,1))*2.0*Q(1,i,j)
  dQ(0)=dQ(0)-2.0d0*(AH(2,2)-A(2,2))*2.0*Q(0,i,j)
  dQ(0)=dQ(0)+2.0d0*(AH(2,3)-A(2,3))*2.0*Q(3,i,j)
  dQ(0)=dQ(0)+2.0d0*(AH(3,1)-A(3,1))*2.0*Q(2,i,j)
  dQ(0)=dQ(0)-2.0d0*(AH(3,2)-A(3,2))*2.0*Q(3,i,j)
  dQ(0)=dQ(0)-2.0d0*(AH(3,3)-A(3,3))*2.0*Q(0,i,j)
  dQ(0)=dQ(0)+2.0d0*zz*2.0*Q(0,i,j)
  dQ(1)=     -2.0d0*(AH(1,1)-A(1,1))*2.0*Q(1,i,j)
  dQ(1)=dQ(1)+2.0d0*(AH(1,2)-A(1,2))*2.0*Q(0,i,j)
  dQ(1)=dQ(1)-2.0d0*(AH(1,3)-A(1,3))*2.0*Q(3,i,j)
  dQ(1)=dQ(1)+2.0d0*(AH(2,1)-A(2,1))*2.0*Q(0,i,j)
  dQ(1)=dQ(1)+2.0d0*(AH(2,2)-A(2,2))*2.0*Q(1,i,j)
  dQ(1)=dQ(1)+2.0d0*(AH(2,3)-A(2,3))*2.0*Q(2,i,j)
  dQ(1)=dQ(1)+2.0d0*(AH(3,1)-A(3,1))*2.0*Q(3,i,j)
  dQ(1)=dQ(1)+2.0d0*(AH(3,2)-A(3,2))*2.0*Q(2,i,j)
  dQ(1)=dQ(1)-2.0d0*(AH(3,3)-A(3,3))*2.0*Q(1,i,j)
  dQ(1)=dQ(1)+2.0d0*zz*2.0*Q(1,i,j)
  dQ(2)=     -2.0d0*(AH(1,1)-A(1,1))*2.0*Q(2,i,j)
  dQ(2)=dQ(2)+2.0d0*(AH(1,2)-A(1,2))*2.0*Q(3,i,j)
  dQ(2)=dQ(2)+2.0d0*(AH(1,3)-A(1,3))*2.0*Q(0,i,j)
  dQ(2)=dQ(2)-2.0d0*(AH(2,1)-A(2,1))*2.0*Q(3,i,j)
  dQ(2)=dQ(2)-2.0d0*(AH(2,2)-A(2,2))*2.0*Q(2,i,j)
  dQ(2)=dQ(2)+2.0d0*(AH(2,3)-A(2,3))*2.0*Q(1,i,j)
  dQ(2)=dQ(2)+2.0d0*(AH(3,1)-A(3,1))*2.0*Q(0,i,j)
  dQ(2)=dQ(2)+2.0d0*(AH(3,2)-A(3,2))*2.0*Q(1,i,j)
  dQ(2)=dQ(2)+2.0d0*(AH(3,3)-A(3,3))*2.0*Q(2,i,j)
  dQ(2)=dQ(2)+2.0d0*zz*2.0*Q(2,i,j)
  do k=0,3
    Q(k,i,j)=Q(k,i,j)-ds*dQ(k)
  enddo
enddo
norm=dot_product(Q(:,i,j),Q(:,i,j))
norm=sqrt(norm)
Q(:,i,j)=Q(:,i,j)/norm
return
end
